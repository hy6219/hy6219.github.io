# M:N ì—°ê´€ê´€ê³„-ì¤‘ê°„ í…Œì´ë¸”ì„ ì—”í‹°í‹°ë¡œ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°

![https://raw.githubusercontent.com/hy6219/TIL/main/Spring/JPA/Entity/RelationShip/OneToOne.png](https://raw.githubusercontent.com/hy6219/TIL/main/Spring/JPA/Entity/RelationShip/OneToOne.png)

ì‹¤ë¬´ì—ì„œëŠ” ê±°ì˜ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ê´€ê³„

ìœ„ì˜ ê²½ìš°ëŠ” Book:Author=M:N ê´€ê³„

## 01. ë¨¼ì € ì§€ë‚œì‹œê°„ì— ë§Œë“¤ì—ˆë˜ Author ì—”í‹°í‹°ë¥¼ ì ê²€í•´ë³´ì `@ManyToMany`

ğŸŒŸ ManyToManyëŠ” ì»¬ë ‰ì…˜ìœ¼ë¡œ ì°¸ì¡°í•  í•„ë“œë¥¼ ë‘ì–´ì•¼ í•œë‹¤!

```java
package com.example.jpa_entity.domain;

import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.ToString;

import javax.persistence.*;
import java.util.ArrayList;
import java.util.List;

@Data
@NoArgsConstructor
@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
@Entity
public class Author extends BaseEntity{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String country;

    @ManyToMany
    private List<Book> books=new ArrayList<>();
}
```

ê·¸ë¦¬ê³  ì´ì™€ ì—°ê²°ë˜ëŠ” Repositoryì¸ AuthorRepositoryë¥¼ ë§Œë“¤ì(ì§€ë‚œì‹œê°„ì— ë§Œë“¤ì—ˆìŒ)

```java
package com.example.jpa_entity.repository;

import com.example.jpa_entity.domain.Author;
import org.springframework.data.jpa.repository.JpaRepository;

public interface AuthorRepository extends JpaRepository<Author,Long> {
}
```

## 02. Book ì¸¡ì—ë„ Authorì™€ ì—°ê²°ë˜ë„ë¡ í•„ë“œë¥¼ ì¶”ê°€- `@ManyToMany`

Bookì¸¡ì—ë„ Authorì™€ ì—°ê²°ë˜ëŠ” í•„ë“œë¥¼ ì¶”ê°€í•´ì£¼ì

```java
package com.example.jpa_entity.domain;

import com.example.jpa_entity.domain.listener.Auditable;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.ToString;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import javax.persistence.*;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Data
@NoArgsConstructor
@Entity
@ToString(callSuper = true)
@EqualsAndHashCode(callSuper=true)
///@EntityListeners(value=MyEntityListener.class)
//@EntityListeners(value= AuditingEntityListener.class)
public class Book extends BaseEntity/* implements Auditable*/ {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    //ì±… ì´ë¦„
    private String name;

    private String category;

    //ì±… ì €ì
    private Long authorId;

//    private Long publisherId;

    @OneToOne(mappedBy = "book")
    @ToString.Exclude
    private BookReviewInfo bookReviewInfo;

    @OneToMany
    @JoinColumn(name="book_id")
    @ToString.Exclude
    private List<Review> reviews=new ArrayList<>();

    @ManyToOne
    @ToString.Exclude
    private Publisher publisher;

    **@ManyToMany
    private List<Author> authors=new ArrayList<>(;**
}
```

## 03. DDL ì‚´í´ë³´ê¸°

ìš°ì„ , ì—¬ê¸°ê¹Œì§€ í•´ì„œ ì§€ë‚œ ì‹œê°„ì— ì§„í–‰í–ˆë˜ í…ŒìŠ¤íŠ¸ë¥¼ ì´ìš©í•´ì„œ DDLì´ ì–´ë–»ê²Œ ì§„í–‰ë˜ëŠ” ì§€ ì‚´í´ë³´ì

```java
		@Test
    @Transactional
    public void bookRelationTest(){
        //Bookì •ë³´ì™€ Review ì •ë³´ë¥¼ ì €ì¥
        givenBookAndReview();
        User user=userRepository.findByEmail("martin@fastcampus.com");
        System.out.println("User : (userRepository)-"+user);
        System.out.println("Review<-User: "+user.getReviews());
        System.out.println("Book<-Review<-User: "+user.getReviews().get(0).getBook());
        System.out.println("Publisher<-Book<-Review<-User: "+user.getReviews().get(0).getBook().getPublisher());
    }
```

```java
Hibernate: 
    
    create table author (
       id bigint generated by default as identity,
        created_at timestamp,
        updated_at timestamp,
        country varchar(255),
        name varchar(255),
        primary key (id)
    )
Hibernate: 
    
    create table author_books (
       author_id bigint not null,
        books_id bigint not null
    )
Hibernate: 
    
    create table book (
       id bigint generated by default as identity,
        created_at timestamp,
        updated_at timestamp,
        **author_id bigint,**
        category varchar(255),
        name varchar(255),
        publisher_id bigint,
        primary key (id)
    )
Hibernate: 
    
    create table book_authors (
       book_id bigint not null,
        authors_id bigint not null
    )
```

ë‹¤ë¥¸ í…Œì´ë¸”ì€ ë’¤ë¡œ í•˜ê³ , ë¨¼ì € Authorì™€ Bookê³¼ ê´€ë ¨ëœ í…Œì´ë¸”ë“¤ë§Œ ì‚´í´ë³´ì•˜ë‹¤

ê·¸ëŸ¬ë©´ Book í…Œì´ë¸”ì—ëŠ” "author_id"ê°€ ìƒê¸´ ê²ƒì„ ì•Œ ìˆ˜ ìˆê³ , Book_Authorsë¼ëŠ” ì¤‘ê°„ í…Œì´ë¸”ì´ ìƒê¸´ ê²ƒì„ í™•ì¸í•´ë³¼ ìˆ˜ ìˆë‹¤

â• `@OneToMany` ì—ì„œëŠ” `Many` ì¸¡ì— FKí‚¤ë¡œì¨ ì°¸ì¡°ë˜ëŠ” í…Œì´ë¸” ì¸¡ì˜ PKê°’ì´ ì €ì¥ë˜ì§€ë§Œ

`@ManyToManyì—ì„œëŠ”` FKë¡œ êµ¬í•  PKë¥¼ ì–»ê¸°ê°€ ì–´ë µë‹¤

ê·¸ë˜ì„œ ì¤‘ê°„ í…Œì´ë¸”ì—ì„œ ë§¤í•‘í•˜ê²Œ ë˜ëŠ” ê²ƒì„ í”¼í•˜ê¸° ì–´ë µë‹¤

ê°„ë‹¨í•˜ê²Œ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ì„œ ManyToManyê°€ ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ”ì§€ ì‚´í´ë³´ë„ë¡ í•˜ì

```java
package com.example.jpa_entity.repository;

import com.example.jpa_entity.domain.Author;
import com.example.jpa_entity.domain.Book;
import org.assertj.core.util.Lists;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.ArrayList;
import java.util.Arrays;

import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
class AuthorRepositoryTest {

    @Autowired
    private AuthorRepository authorRepository;

    @Autowired
    private BookRepository bookRepository;

    private Book givenBook(String name){
        Book book=new Book();
        book.setName(name);

        return bookRepository.save(book);
    }

    private Author givenAuthor(String name){
        Author author=new Author();

        author.setName(name);
        return authorRepository.save(author);
    }

    @Test
    public void manyToManyTest(){
        Book book1=givenBook("ì±…1");
        Book book2=givenBook("ì±…2");
        Book book3=givenBook("ê°œë°œì±…1");
        Book book4=givenBook("ê°œë°œì±…2");

        Author author1=givenAuthor("martin");
        Author author2=givenAuthor("steve");

        //ì—°ê´€ê´€ê³„ ë„£ì–´ì£¼ê¸°
        book1.setAuthors(Lists.newArrayList(author1));
        book2.setAuthors(Lists.newArrayList(author2));
        book3.setAuthors(Lists.newArrayList(author1,author2));
        book4.setAuthors(Lists.newArrayList(author1,author2));

        author1.setBooks(Lists.newArrayList(book1,book3,book4));
        author2.setBooks(Lists.newArrayList(book2,book3,book4));

        bookRepository.saveAll(Lists.newArrayList(book1,book2,book3,book4));
        authorRepository.saveAll(Lists.newArrayList(author1,author2));

        

    }
}
```

ìœ„ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•´ë³´ë©´, LazyInitialization Exceptionì´ ë°œìƒí•˜ëŠ” ê²ƒì„ í™•ì¸í•´ë³¼ ìˆ˜ ìˆë‹¤

ê·¸ë¦¬ê³  ì ê¹ ë³´ë‹¤ ì‹¤ì§ˆì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” í˜•íƒœë¥¼ ì ê¹ ì‚´í´ë³´ê³  ì½”ë“œë¥¼ ì •ë¦¬í•´ë³´ì

---

ì°¸ê³ ë¡œ, ì§€ê¸ˆì€ í…ŒìŠ¤íŠ¸ì—ì„œ ì§„í–‰í•  ë•Œ `given~`ì´ë¼ëŠ” ë©”ì„œë“œë¡œ ë°ì´í„°ë¥¼ ì¶”ê°€í•´ì£¼ê³  ìˆì§€ë§Œ í˜„ì—…ì—ì„œëŠ” ì•„ë˜ì²˜ëŸ¼ ì—”í‹°í‹° í´ë˜ìŠ¤ ì•ˆì— ë©”ì„œë“œë¥¼ ë„£ì–´ì„œ ê´€ë¦¬í•œë‹¤ê³  í•œë‹¤

```java
package com.example.jpa_entity.domain;

import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.ToString;

import javax.persistence.*;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;

@Data
@NoArgsConstructor
@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
@Entity
public class Author extends BaseEntity{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String country;

    @ManyToMany
    private List<Book> books=new ArrayList<>();

    **public void addBook(Book...book){
        Collections.addAll(this.books,book);
    }**
}
```

```java

package com.example.jpa_entity.domain;

import com.example.jpa_entity.domain.listener.Auditable;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.ToString;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import javax.persistence.*;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;

@Data
@NoArgsConstructor
@Entity
@ToString(callSuper = true)
@EqualsAndHashCode(callSuper=true)
///@EntityListeners(value=MyEntityListener.class)
//@EntityListeners(value= AuditingEntityListener.class)
public class Book extends BaseEntity/* implements Auditable*/ {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    //ì±… ì´ë¦„
    private String name;

    private String category;

    //ì±… ì €ì
    private Long authorId;

//    private Long publisherId;

    @OneToOne(mappedBy = "book")
    @ToString.Exclude
    private BookReviewInfo bookReviewInfo;

    @OneToMany
    @JoinColumn(name="book_id")
    @ToString.Exclude
    private List<Review> reviews=new ArrayList<>();

    @ManyToOne
    @ToString.Exclude
    private Publisher publisher;

    @ManyToMany
    private List<Author> authors=new ArrayList<>();

    **public void addAuthor(Author...author){
        Collections.addAll(this.authors,author);
    }**

}
```

---

ì´ë ‡ê²Œ ë˜ë©´ ìœ„ì˜ í…ŒìŠ¤íŠ¸ì½”ë“œëŠ” ì•„ë˜ì²˜ëŸ¼ ì •ë¦¬ë  ìˆ˜ ìˆë‹¤

ê·¸ë¦¬ê³  bookìœ¼ë¡œ authorì •ë³´ë“¤ì„ ê°€ì ¸ì™€ë³´ê³ , authorë¡œ bookì •ë³´ë“¤ì„ ê°€ì ¸ì™€ë³´ì

```java
package com.example.jpa_entity.repository;

import com.example.jpa_entity.domain.Author;
import com.example.jpa_entity.domain.Book;
import org.assertj.core.util.Lists;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import javax.transaction.Transactional;
import java.util.ArrayList;
import java.util.Arrays;

import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
class AuthorRepositoryTest {

    @Autowired
    private AuthorRepository authorRepository;

    @Autowired
    private BookRepository bookRepository;

    private Book givenBook(String name){
        Book book=new Book();
        book.setName(name);

        return bookRepository.save(book);
    }

    private Author givenAuthor(String name){
        Author author=new Author();

        author.setName(name);
        return authorRepository.save(author);
    }

    @Test
    public void manyToManyTest(){
        Book book1=givenBook("ì±…1");
        Book book2=givenBook("ì±…2");
        Book book3=givenBook("ê°œë°œì±…1");
        Book book4=givenBook("ê°œë°œì±…2");

        Author author1=givenAuthor("martin");
        Author author2=givenAuthor("steve");

        //ì—°ê´€ê´€ê³„ ë„£ì–´ì£¼ê¸°
        **book1.addAuthor(author1);
        book2.addAuthor(author2);
        book3.addAuthor(author1,author2);
        book4.addAuthor(author1,author2);

        author1.addBook(book1,book3,book4);
        author2.addBook(book2,book3,book4);**

        bookRepository.saveAll(Lists.newArrayList(book1,book2,book3,book4));
        authorRepository.saveAll(Lists.newArrayList(author1,author2));

				System.out.println("authors through book: "+bookRepository.findAll().get(2).getAuthors());
        System.out.println("books through author: "+authorRepository.findAll().get(0).getBooks());

    }
}
```

ì´ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ë³´ë©´ ì•„ì§ í•´ê²°í•˜ì§€ ì•Šì•˜ë˜ Lazy Initialization Exceptionì´ ëœ¬ë‹¤

```java
package com.example.jpa_entity.repository;

import com.example.jpa_entity.domain.Author;
import com.example.jpa_entity.domain.Book;
import org.assertj.core.util.Lists;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import javax.transaction.Transactional;
import java.util.ArrayList;
import java.util.Arrays;

import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
class AuthorRepositoryTest {

    @Autowired
    private AuthorRepository authorRepository;

    @Autowired
    private BookRepository bookRepository;

    private Book givenBook(String name){
        Book book=new Book();
        book.setName(name);

        return bookRepository.save(book);
    }

    private Author givenAuthor(String name){
        Author author=new Author();

        author.setName(name);
        return authorRepository.save(author);
    }

    @Test
    **@Transactional**
    public void manyToManyTest(){
        Book book1=givenBook("ì±…1");
        Book book2=givenBook("ì±…2");
        Book book3=givenBook("ê°œë°œì±…1");
        Book book4=givenBook("ê°œë°œì±…2");

        Author author1=givenAuthor("martin");
        Author author2=givenAuthor("steve");

        //ì—°ê´€ê´€ê³„ ë„£ì–´ì£¼ê¸°
        book1.addAuthor(author1);
        book2.addAuthor(author2);
        book3.addAuthor(author1,author2);
        book4.addAuthor(author1,author2);

        author1.addBook(book1,book3,book4);
        author2.addBook(book2,book3,book4);

        bookRepository.saveAll(Lists.newArrayList(book1,book2,book3,book4));
        authorRepository.saveAll(Lists.newArrayList(author1,author2));

        System.out.println("authors through book: "+bookRepository.findAll().get(2).getAuthors());
        System.out.println("books through author: "+authorRepository.findAll().get(0).getBooks());

    }
}
```

ê·¸ë˜ì„œ í…ŒìŠ¤íŠ¸í•  ë©”ì„œë“œ ìœ„ì— `@Transactional`ì„ ë¶™ì˜€ë”ë‹ˆ StackOverFlowErrorê°€ ë°œìƒí•œë‹¤!

ë°”ë¡œ `toStringìœ¼ë¡œ ì¸í•œ ìˆœí™˜ì°¸ì¡°ê°€ ìˆë‹¤ëŠ” ê²ƒ`ì¸ ê²ƒ ê°™ë‹¤

## 04. `í…ŒìŠ¤íŠ¸ ë©”ì„œë“œ ìœ„ì— @Transactional`, ê·¸ë¦¬ê³  `ToString.Excludeë¥¼ ì´ìš©í•œ ìˆœí™˜ì°¸ì¡° ë§‰ê¸°`

ìœ„ì—ì„œ Transactionalì„ ë¶™ì—¬ì£¼ì—ˆìœ¼ë¯€ë¡œ 

ì´ì–´ì„œ ToString.Excludeë¥¼ ê°ê°ì˜ ì—”í‹°í‹°ì— ë¶™ì—¬ì£¼ì

```java
package com.example.jpa_entity.domain;

import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.ToString;

import javax.persistence.*;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;

@Data
@NoArgsConstructor
@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
@Entity
public class Author extends BaseEntity{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String country;

    @ManyToMany
    **@ToString.Exclude**
    private List<Book> books=new ArrayList<>();

    public void addBook(Book...book){
        Collections.addAll(this.books,book);
    }
}
```

```java
package com.example.jpa_entity.domain;

import com.example.jpa_entity.domain.listener.Auditable;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.ToString;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import javax.persistence.*;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;

@Data
@NoArgsConstructor
@Entity
@ToString(callSuper = true)
@EqualsAndHashCode(callSuper=true)
///@EntityListeners(value=MyEntityListener.class)
//@EntityListeners(value= AuditingEntityListener.class)
public class Book extends BaseEntity/* implements Auditable*/ {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    //ì±… ì´ë¦„
    private String name;

    private String category;

    //ì±… ì €ì
    private Long authorId;

//    private Long publisherId;

    @OneToOne(mappedBy = "book")
    @ToString.Exclude
    private BookReviewInfo bookReviewInfo;

    @OneToMany
    @JoinColumn(name="book_id")
    @ToString.Exclude
    private List<Review> reviews=new ArrayList<>();

    @ManyToOne
    @ToString.Exclude
    private Publisher publisher;

    @ManyToMany
    **@ToString.Exclude**
    private List<Author> authors=new ArrayList<>();

    public void addAuthor(Author...author){
        Collections.addAll(this.authors,author);
    }

}
```

```java
Hibernate: 
    insert 
    into
        book
        (id, created_at, updated_at, author_id, category, name, publisher_id) 
    values
        (null, ?, ?, ?, ?, ?, ?)
Hibernate: 
    insert 
    into
        book
        (id, created_at, updated_at, author_id, category, name, publisher_id) 
    values
        (null, ?, ?, ?, ?, ?, ?)
Hibernate: 
    insert 
    into
        book
        (id, created_at, updated_at, author_id, category, name, publisher_id) 
    values
        (null, ?, ?, ?, ?, ?, ?)
Hibernate: 
    insert 
    into
        book
        (id, created_at, updated_at, author_id, category, name, publisher_id) 
    values
        (null, ?, ?, ?, ?, ?, ?)
Hibernate: 
    insert 
    into
        author
        (id, created_at, updated_at, country, name) 
    values
        (null, ?, ?, ?, ?)
Hibernate: 
    insert 
    into
        author
        (id, created_at, updated_at, country, name) 
    values
        (null, ?, ?, ?, ?)
Hibernate: 
    select
        book0_.id as id1_3_,
        book0_.created_at as created_2_3_,
        book0_.updated_at as updated_3_3_,
        book0_.author_id as author_i4_3_,
        book0_.category as category5_3_,
        book0_.name as name6_3_,
        book0_.publisher_id as publishe7_3_ 
    from
        book book0_
authors through book: [Author(super=BaseEntity(cratedAt=2021-08-31T14:30:03.393, updatedAt=2021-08-31T14:30:03.393), id=1, name=martin, country=null), Author(super=BaseEntity(cratedAt=2021-08-31T14:30:03.401, updatedAt=2021-08-31T14:30:03.401), id=2, name=steve, country=null)]
Hibernate: 
    select
        author0_.id as id1_1_,
        author0_.created_at as created_2_1_,
        author0_.updated_at as updated_3_1_,
        author0_.country as country4_1_,
        author0_.name as name5_1_ 
    from
        author author0_
books through author: [Book(super=BaseEntity(cratedAt=2021-08-31T14:30:03.316, updatedAt=2021-08-31T14:30:03.316), id=1, name=ì±…1, category=null, authorId=null), Book(super=BaseEntity(cratedAt=2021-08-31T14:30:03.386, updatedAt=2021-08-31T14:30:03.386), id=3, name=ê°œë°œì±…1, category=null, authorId=null), Book(super=BaseEntity(cratedAt=2021-08-31T14:30:03.387, updatedAt=2021-08-31T14:30:03.387), id=4, name=ê°œë°œì±…2, category=null, authorId=null)]
```

ê·¸ëŸ¬ë©´ ì´ë²ˆì—ëŠ” ì œëŒ€ë¡œ ì˜ ë™ì‘í•´ì„œ bookì„ í†µí•´ì„œ authorsë¥¼, authorë¥¼ í†µí•´ booksë¥¼ ì‚´í´ë³¼ ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤

ğŸŒŸ ì´ë¥¼ í†µí•´ì„œ, ì—°ê´€ê´€ê³„ì—ì„œ getterë¥¼ í†µí•´ ì—°ê²°ëœ í…Œì´ë¸” ì •ë³´ë¥¼ í™•ì¸í•´ë³¼ ìˆ˜ ìˆìŒì„ ë‹¤ì‹œ í•œ ë²ˆ ì‚´í´ë³¼ ìˆ˜ ìˆì—ˆë‹¤